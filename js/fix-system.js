// SOLUCI√ìN DIRECTA Y ROBUSTA PARA EL SISTEMA DE REGISTRO Y LOGIN

// 1. FORZAR RECONFIGURACI√ìN COMPLETA DEL SISTEMA
function forzarConfiguracionCompleta() {
    console.log('üîß === FORZANDO CONFIGURACI√ìN COMPLETA ===');
    
    // Esperar a que DOM est√© completamente cargado
    if (document.readyState !== 'complete') {
        console.log('‚è≥ Esperando a que termine de cargar...');
        window.addEventListener('load', forzarConfiguracionCompleta);
        return;
    }
    
    // 1. Cargar usuarios demo si no existen
    cargarUsuariosDemo();
    
    // 2. Configurar formularios con event listeners directos
    configurarFormulariosDirectos();
    
    // 3. Configurar botones de modal
    configurarBotonesModales();
    
    // 4. Mostrar estado del sistema
    mostrarEstadoSistema();
    
    console.log('‚úÖ Configuraci√≥n completa finalizada');
}

// 2. CARGAR USUARIOS DEMO GARANTIZADO (SIN AUTO-INSCRIPCI√ìN)
function cargarUsuariosDemo() {
    console.log('üë• Cargando usuarios demo...');
    
    const usuariosExistentes = JSON.parse(localStorage.getItem('usuarios')) || [];
    console.log(`üìä Usuarios existentes: ${usuariosExistentes.length}`);
    
    // Crear usuarios demo si no existen - SOLO USUARIOS, NO MATERIAS
    const usuariosDemo = [
        {
            id: 'demo-est-001',
            tipo: 'estudiante',
            nombre: 'Mar√≠a Jos√©',
            apellido1: 'Hern√°ndez',
            apellido2: 'Garc√≠a',
            nombreCompleto: 'Mar√≠a Jos√© Hern√°ndez Garc√≠a',
            cedula: '11111111-1',
            fechaNacimiento: '2001-03-15',
            email: 'maria.hernandez@estudiante.demo.com',
            telefono: '+50611111111',
            direccion: 'San Jos√©, Costa Rica',
            carrera: 'ingenieria-sistemas',
            semestre: '4',
            password: 'estudiante123',
            fechaRegistro: new Date().toISOString(),
            estado: 'activo'
        },
        {
            id: 'demo-prof-001',
            tipo: 'profesor',
            nombre: 'Laura',
            apellido1: 'Mendoza',
            apellido2: 'Silva',
            nombreCompleto: 'Dra. Laura Mendoza Silva',
            cedula: '22222222-2',
            fechaNacimiento: '1980-08-20',
            email: 'laura.mendoza@profesor.demo.com',
            telefono: '+50622222222',
            direccion: 'Cartago, Costa Rica',
            especialidad: 'Ingenier√≠a de Software',
            titulo: 'Doctora en Ciencias de la Computaci√≥n',
            experiencia: '15',
            password: 'profesor123',
            fechaRegistro: new Date().toISOString(),
            estado: 'activo'
        },
        {
            id: 'demo-admin-001',
            tipo: 'administrador',
            nombre: 'Ana',
            apellido1: 'Rodr√≠guez',
            apellido2: 'L√≥pez',
            nombreCompleto: 'Ana Rodr√≠guez L√≥pez',
            cedula: '33333333-3',
            fechaNacimiento: '1985-12-10',
            email: 'admin@sistema.com',
            telefono: '+50633333333',
            direccion: 'San Jos√©, Costa Rica',
            password: 'admin123',
            fechaRegistro: new Date().toISOString(),
            estado: 'activo',
            permisos: ['gestionar_usuarios', 'gestionar_materias', 'ver_reportes']
        }
    ];
    
    // Verificar si ya existen y agregarlos si no
    let usuariosActualizados = [...usuariosExistentes];
    let agregados = 0;
    
    usuariosDemo.forEach(demo => {
        const existe = usuariosActualizados.find(u => u.email === demo.email);
        if (!existe) {
            usuariosActualizados.push(demo);
            agregados++;
            console.log(`   ‚úÖ Usuario demo agregado: ${demo.email} (${demo.tipo})`);
        }
    });
    
    if (agregados > 0) {
        localStorage.setItem('usuarios', JSON.stringify(usuariosActualizados));
        console.log(`‚úÖ ${agregados} usuarios demo agregados`);
    } else {
        console.log('‚úÖ Usuarios demo ya exist√≠an');
    }
    
    // Actualizar variable global
    window.usuarios = usuariosActualizados;
    
    console.log(`üë• Total usuarios: ${usuariosActualizados.length}`);
    
    // IMPORTANTE: NO crear materias autom√°ticamente
    // Las materias deben ser creadas por los profesores
    console.log('‚ÑπÔ∏è Materias deben ser creadas manualmente por cada profesor');
}

// 3. CONFIGURAR FORMULARIOS CON EVENT LISTENERS DIRECTOS
function configurarFormulariosDirectos() {
    console.log('üìù Configurando formularios directamente...');
    
    // FORMULARIO DE ESTUDIANTE
    const formEstudiante = document.getElementById('formEstudiante');
    if (formEstudiante) {
        // Remover listeners existentes
        const nuevoFormEst = formEstudiante.cloneNode(true);
        formEstudiante.parentNode.replaceChild(nuevoFormEst, formEstudiante);
        
        // Agregar nuevo listener
        nuevoFormEst.onsubmit = function(e) {
            e.preventDefault();
            console.log('üìù FORMULARIO ESTUDIANTE ENVIADO');
            procesarRegistroEstudiante(e);
        };
        
        console.log('‚úÖ Formulario estudiante configurado');
    } else {
        console.error('‚ùå Formulario estudiante no encontrado');
    }
    
    // FORMULARIO DE PROFESOR
    const formProfesor = document.getElementById('formProfesor');
    if (formProfesor) {
        // Remover listeners existentes
        const nuevoFormProf = formProfesor.cloneNode(true);
        formProfesor.parentNode.replaceChild(nuevoFormProf, formProfesor);
        
        // Agregar nuevo listener
        nuevoFormProf.onsubmit = function(e) {
            e.preventDefault();
            console.log('üìù FORMULARIO PROFESOR ENVIADO');
            procesarRegistroProfesor(e);
        };
        
        console.log('‚úÖ Formulario profesor configurado');
    } else {
        console.error('‚ùå Formulario profesor no encontrado');
    }
    
    // FORMULARIO DE LOGIN
    const formLogin = document.getElementById('loginForm');
    if (formLogin) {
        // Remover listeners existentes
        const nuevoFormLogin = formLogin.cloneNode(true);
        formLogin.parentNode.replaceChild(nuevoFormLogin, formLogin);
        
        // Agregar nuevo listener
        nuevoFormLogin.onsubmit = function(e) {
            e.preventDefault();
            console.log('üîë FORMULARIO LOGIN ENVIADO');
            procesarLogin(e);
        };
        
        console.log('‚úÖ Formulario login configurado');
    } else {
        console.error('‚ùå Formulario login no encontrado');
    }
}

// 4. PROCESAR REGISTRO DE ESTUDIANTE (MEJORADO)
function procesarRegistroEstudiante(e) {
    console.log('üë§ === PROCESANDO REGISTRO DE ESTUDIANTE ===');
    
    try {
        const formData = new FormData(e.target);
        
        // Obtener datos del formulario
        const datos = {
            nombre: formData.get('nombre')?.trim() || '',
            apellido1: formData.get('apellido1')?.trim() || '',
            apellido2: formData.get('apellido2')?.trim() || '',
            cedula: formData.get('cedula')?.trim() || '',
            fechaNacimiento: formData.get('fechaNacimiento') || '',
            email: formData.get('email')?.trim() || '',
            telefono: formData.get('telefono')?.trim() || '',
            direccion: formData.get('direccion')?.trim() || '',
            carrera: formData.get('carrera') || '',
            semestre: formData.get('semestre') || '',
            password: formData.get('password') || ''
        };
        
        console.log('üìã Datos recibidos:', datos);
        
        // Validaciones b√°sicas MEJORADAS
        if (!datos.nombre || !datos.apellido1 || !datos.email || !datos.password) {
            mostrarMensaje('‚ùå Nombre, primer apellido, email y contrase√±a son obligatorios', 'error');
            return false;
        }
        
        if (datos.password.length < 6) {
            mostrarMensaje('‚ùå La contrase√±a debe tener al menos 6 caracteres', 'error');
            return false;
        }
        
        // Validar formato de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(datos.email)) {
            mostrarMensaje('‚ùå El formato del email no es v√°lido', 'error');
            return false;
        }
        
        // Verificar si el email ya existe (RECARGAR USUARIOS ACTUALES)
        const usuariosActuales = JSON.parse(localStorage.getItem('usuarios')) || [];
        const emailExiste = usuariosActuales.find(u => u.email.toLowerCase() === datos.email.toLowerCase());
        
        if (emailExiste) {
            mostrarMensaje(`‚ùå El email ${datos.email} ya est√° registrado`, 'error');
            return false;
        }
        
        // Crear estudiante - SOLO USUARIO, SIN INSCRIPCIONES AUTOM√ÅTICAS
        const estudiante = {
            id: 'est_' + Date.now(),
            tipo: 'estudiante',
            ...datos,
            nombreCompleto: `${datos.nombre} ${datos.apellido1}${datos.apellido2 ? ' ' + datos.apellido2 : ''}`,
            fechaRegistro: new Date().toISOString(),
            estado: 'activo'
            // NO inscribir autom√°ticamente a materias
        };
        
        console.log('üë§ Estudiante creado:', estudiante);
        
        // Guardar SOLO el usuario en localStorage
        usuariosActuales.push(estudiante);
        localStorage.setItem('usuarios', JSON.stringify(usuariosActuales));
        window.usuarios = usuariosActuales;
        
        console.log('üíæ Usuario guardado en localStorage');
        console.log('‚ÑπÔ∏è IMPORTANTE: Estudiante debe inscribirse a materias despu√©s');
        
        // Mostrar √©xito con instrucciones
        mostrarMensaje('‚úÖ Estudiante registrado. Debe inscribirse a materias despu√©s del login.', 'success');
        
        // Limpiar formulario
        e.target.reset();
        
        // Cerrar modal despu√©s de un momento
        setTimeout(() => {
            cerrarModal('registroModal');
        }, 2000);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error procesando registro:', error);
        mostrarMensaje('‚ùå Error al registrar. Verifica todos los campos.', 'error');
        return false;
    }
}

// 5. PROCESAR REGISTRO DE PROFESOR (MEJORADO)
function procesarRegistroProfesor(e) {
    console.log('üë®‚Äçüè´ === PROCESANDO REGISTRO DE PROFESOR ===');
    
    try {
        const formData = new FormData(e.target);
        
        // Obtener datos del formulario
        const datos = {
            nombre: formData.get('nombre')?.trim() || '',
            apellido1: formData.get('apellido1')?.trim() || '',
            apellido2: formData.get('apellido2')?.trim() || '',
            cedula: formData.get('cedula')?.trim() || '',
            fechaNacimiento: formData.get('fechaNacimiento') || '',
            email: formData.get('email')?.trim() || '',
            telefono: formData.get('telefono')?.trim() || '',
            direccion: formData.get('direccion')?.trim() || '',
            especialidad: formData.get('especialidad')?.trim() || '',
            titulo: formData.get('titulo')?.trim() || '',
            experiencia: formData.get('experiencia') || '',
            password: formData.get('password') || ''
        };
        
        console.log('üìã Datos recibidos:', datos);
        
        // Validaciones b√°sicas MEJORADAS
        if (!datos.nombre || !datos.apellido1 || !datos.email || !datos.password) {
            mostrarMensaje('‚ùå Nombre, primer apellido, email y contrase√±a son obligatorios', 'error');
            return false;
        }
        
        if (datos.password.length < 6) {
            mostrarMensaje('‚ùå La contrase√±a debe tener al menos 6 caracteres', 'error');
            return false;
        }
        
        // Validar formato de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(datos.email)) {
            mostrarMensaje('‚ùå El formato del email no es v√°lido', 'error');
            return false;
        }
        
        // Verificar si el email ya existe (RECARGAR USUARIOS ACTUALES)
        const usuariosActuales = JSON.parse(localStorage.getItem('usuarios')) || [];
        const emailExiste = usuariosActuales.find(u => u.email.toLowerCase() === datos.email.toLowerCase());
        
        if (emailExiste) {
            mostrarMensaje(`‚ùå El email ${datos.email} ya est√° registrado`, 'error');
            return false;
        }
        
        // Crear profesor - SIN MATERIAS NI ESTUDIANTES AUTOM√ÅTICOS
        const profesor = {
            id: 'prof_' + Date.now(),
            tipo: 'profesor',
            ...datos,
            nombreCompleto: `${datos.titulo ? datos.titulo + ' ' : ''}${datos.nombre} ${datos.apellido1}${datos.apellido2 ? ' ' + datos.apellido2 : ''}`,
            fechaRegistro: new Date().toISOString(),
            estado: 'activo'
            // NO agregar materias ni estudiantes autom√°ticamente
            // El profesor debe crear sus materias despu√©s del login
        };
        
        console.log('üë®‚Äçüè´ Profesor creado:', profesor);
        
        // Guardar SOLO el usuario en localStorage
        usuariosActuales.push(profesor);
        localStorage.setItem('usuarios', JSON.stringify(usuariosActuales));
        window.usuarios = usuariosActuales;
        
        console.log('üíæ Usuario guardado en localStorage');
        console.log('‚ÑπÔ∏è IMPORTANTE: Profesor debe crear sus materias despu√©s del login');
        
        // Mostrar √©xito con instrucciones claras
        mostrarMensaje('‚úÖ Profesor registrado. Debe crear materias e inscribir estudiantes despu√©s del login.', 'success');
        
        // Limpiar formulario
        e.target.reset();
        
        // Cerrar modal despu√©s de un momento
        setTimeout(() => {
            cerrarModal('registroModal');
        }, 3000); // M√°s tiempo para leer el mensaje
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error procesando registro:', error);
        mostrarMensaje('‚ùå Error al registrar. Verifica todos los campos.', 'error');
        return false;
    }
}

// 6. PROCESAR LOGIN (MEJORADO)
function procesarLogin(e) {
    console.log('üîë === PROCESANDO LOGIN ===');
    
    try {
        const formData = new FormData(e.target);
        
        const datos = {
            email: formData.get('email')?.trim() || '',
            password: formData.get('password') || '',
            userType: formData.get('userType') || ''
        };
        
        console.log('üìã Datos de login:', { email: datos.email, userType: datos.userType });
        
        // Validaciones b√°sicas
        if (!datos.email || !datos.password || !datos.userType) {
            mostrarMensaje('‚ùå Todos los campos son obligatorios', 'error');
            return false;
        }
        
        // Obtener usuarios ACTUALES (recargar desde localStorage)
        const usuariosActuales = JSON.parse(localStorage.getItem('usuarios')) || [];
        console.log(`üë• Buscando entre ${usuariosActuales.length} usuarios registrados`);
        
        // Buscar usuario (case insensitive para email)
        const usuario = usuariosActuales.find(u => 
            u.email.toLowerCase() === datos.email.toLowerCase() && 
            u.password === datos.password && 
            u.tipo === datos.userType
        );
        
        if (usuario) {
            console.log('‚úÖ Usuario encontrado:', usuario.email);
            
            // Verificar que el usuario est√© activo
            if (usuario.estado !== 'activo') {
                mostrarMensaje('‚ùå La cuenta est√° inactiva. Contacta al administrador.', 'error');
                return false;
            }
            
            // Guardar sesi√≥n
            window.usuarioActual = usuario;
            localStorage.setItem('usuarioActual', JSON.stringify(usuario));
            
            // Mostrar √©xito
            const tipoCapitalizado = usuario.tipo.charAt(0).toUpperCase() + usuario.tipo.slice(1);
            mostrarMensaje(`‚úÖ Bienvenido, ${usuario.nombreCompleto} (${tipoCapitalizado})`, 'success');
            
            // Cerrar modal y mostrar dashboard
            setTimeout(() => {
                cerrarModal('loginModal');
                setTimeout(() => {
                    mostrarDashboardMejorado(usuario);
                }, 1000);
            }, 1500);
            
            return true;
            
        } else {
            console.log('‚ùå Usuario no encontrado o credenciales incorrectas');
            console.log('üìã Usuarios disponibles para debug:');
            usuariosActuales.forEach(u => {
                console.log(`   - ${u.email} (${u.tipo}) - Estado: ${u.estado}`);
            });
            
            mostrarMensaje('‚ùå Email, contrase√±a o tipo de usuario incorrectos', 'error');
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Error procesando login:', error);
        mostrarMensaje('‚ùå Error al iniciar sesi√≥n. Intenta de nuevo.', 'error');
        return false;
    }
}

// 7. MOSTRAR MENSAJE (SIMPLE Y DIRECTO)
function mostrarMensaje(mensaje, tipo) {
    console.log(`üì¢ ${mensaje}`);
    
    // Crear o usar notificaci√≥n existente
    let notificacion = document.getElementById('notificacion-fix');
    
    if (!notificacion) {
        notificacion = document.createElement('div');
        notificacion.id = 'notificacion-fix';
        notificacion.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            max-width: 300px;
            transition: all 0.3s ease;
        `;
        document.body.appendChild(notificacion);
    }
    
    // Configurar estilos seg√∫n el tipo
    if (tipo === 'success') {
        notificacion.style.backgroundColor = '#28a745';
    } else if (tipo === 'error') {
        notificacion.style.backgroundColor = '#dc3545';
    } else {
        notificacion.style.backgroundColor = '#007bff';
    }
    
    notificacion.textContent = mensaje;
    notificacion.style.display = 'block';
    
    // Ocultar despu√©s de 3 segundos
    setTimeout(() => {
        notificacion.style.display = 'none';
    }, 3000);
}

// 8. CERRAR MODAL
function cerrarModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        console.log(`‚úÖ Modal ${modalId} cerrado`);
    }
}

// 9. DASHBOARD MEJORADO SEG√öN TIPO DE USUARIO
function mostrarDashboardMejorado(usuario) {
    console.log('üéØ === MOSTRANDO DASHBOARD MEJORADO ===');
    console.log(`üë§ Usuario: ${usuario.email} (${usuario.tipo})`);
    
    // Ocultar contenido principal
    const elementsToHide = ['.header', '.hero', '.about', 'footer', '.modal'];
    elementsToHide.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => el.style.display = 'none');
    });
    
    // Crear dashboard espec√≠fico
    let dashboard = document.getElementById('dashboard-mejorado');
    if (!dashboard) {
        dashboard = document.createElement('div');
        dashboard.id = 'dashboard-mejorado';
        dashboard.style.cssText = `
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            background: #f8f9fa;
        `;
        document.body.appendChild(dashboard);
    }
    
    // Contenido espec√≠fico seg√∫n tipo de usuario
    let contenidoEspecifico = '';
    
    if (usuario.tipo === 'estudiante') {
        contenidoEspecifico = `
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="color: #007bff; margin: 0 0 15px 0;">üìö Panel de Estudiante</h3>
                <p><strong>Carrera:</strong> ${usuario.carrera || 'No especificada'}</p>
                <p><strong>Semestre:</strong> ${usuario.semestre || 'No especificado'}</p>
                <div style="margin-top: 15px;">
                    <h4>Pr√≥ximas funciones:</h4>
                    <ul>
                        <li>üìã Ver materias disponibles</li>
                        <li>‚úèÔ∏è Inscribirse a materias</li>
                        <li>üìä Ver calificaciones</li>
                        <li>üìÖ Ver horarios de clase</li>
                        <li>üìà Seguimiento de asistencia</li>
                    </ul>
                </div>
            </div>
        `;
    } else if (usuario.tipo === 'profesor') {
        contenidoEspecifico = `
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="color: #28a745; margin: 0 0 15px 0;">üë®‚Äçüè´ Panel de Profesor</h3>
                <p><strong>Especialidad:</strong> ${usuario.especialidad || 'No especificada'}</p>
                <p><strong>T√≠tulo:</strong> ${usuario.titulo || 'No especificado'}</p>
                <p><strong>Experiencia:</strong> ${usuario.experiencia || 'No especificada'} a√±os</p>
                <div style="margin-top: 15px;">
                    <h4>Pr√≥ximas funciones:</h4>
                    <ul>
                        <li>üìö Crear y gestionar materias</li>
                        <li>üë• Inscribir estudiantes a materias</li>
                        <li>üìä Registrar calificaciones</li>
                        <li>üìÖ Gestionar horarios</li>
                        <li>üìà Control de asistencias</li>
                        <li>üìù Generar reportes</li>
                    </ul>
                </div>
            </div>
        `;
    } else if (usuario.tipo === 'administrador') {
        const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        const totalEstudiantes = usuarios.filter(u => u.tipo === 'estudiante').length;
        const totalProfesores = usuarios.filter(u => u.tipo === 'profesor').length;
        
        contenidoEspecifico = `
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="color: #dc3545; margin: 0 0 15px 0;">‚öôÔ∏è Panel de Administrador</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0; color: #1565c0;">üë• Usuarios</h4>
                        <p style="margin: 5px 0; font-size: 24px; font-weight: bold;">${usuarios.length}</p>
                    </div>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0; color: #2e7d32;">üë®‚Äçüè´ Profesores</h4>
                        <p style="margin: 5px 0; font-size: 24px; font-weight: bold;">${totalProfesores}</p>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0; color: #ef6c00;">üéì Estudiantes</h4>
                        <p style="margin: 5px 0; font-size: 24px; font-weight: bold;">${totalEstudiantes}</p>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Funciones de administrador:</h4>
                    <ul>
                        <li>üë• Gestionar usuarios (crear, editar, eliminar)</li>
                        <li>üìö Supervisar materias y asignaciones</li>
                        <li>üìä Ver reportes del sistema</li>
                        <li>‚öôÔ∏è Configurar sistema</li>
                        <li>üîí Gestionar permisos</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    dashboard.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
            <h1 style="margin: 0 0 10px 0; font-size: 2.5em;">‚úÖ Sistema Funcionando Correctamente</h1>
            <h2 style="margin: 0; opacity: 0.9;">Bienvenido, ${usuario.nombreCompleto}</h2>
            <p style="margin: 10px 0 0 0; opacity: 0.8;">
                <strong>Email:</strong> ${usuario.email} | 
                <strong>Tipo:</strong> ${usuario.tipo.charAt(0).toUpperCase() + usuario.tipo.slice(1)} |
                <strong>Estado:</strong> ${usuario.estado.charAt(0).toUpperCase() + usuario.estado.slice(1)}
            </p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            ${contenidoEspecifico}
            
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #17a2b8; margin: 0 0 15px 0;">ÔøΩ Sistema</h3>
                <div style="margin-bottom: 15px;">
                    <p><strong>‚úÖ Registro:</strong> Funcionando</p>
                    <p><strong>‚úÖ Login:</strong> Funcionando</p>
                    <p><strong>‚úÖ Validaciones:</strong> Activas</p>
                    <p><strong>‚úÖ Base de datos:</strong> LocalStorage</p>
                </div>
                
                <h4 style="margin: 15px 0 10px 0;">Credenciales Demo:</h4>
                <div style="font-size: 0.9em; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <p style="margin: 5px 0;"><strong>Estudiante:</strong><br>
                    üìß maria.hernandez@estudiante.demo.com<br>
                    üîí estudiante123</p>
                    
                    <p style="margin: 5px 0;"><strong>Profesor:</strong><br>
                    üìß laura.mendoza@profesor.demo.com<br>
                    üîí profesor123</p>
                    
                    <p style="margin: 5px 0;"><strong>Admin:</strong><br>
                    üìß admin@sistema.com<br>
                    üîí admin123</p>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button onclick="cerrarSesionMejorado()" style="background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; margin-right: 15px; font-size: 16px;">
                üö™ Cerrar Sesi√≥n
            </button>
            <button onclick="volverAlInicio()" style="background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                üè† Volver al Inicio
            </button>
        </div>
    `;
    
    console.log('‚úÖ Dashboard mejorado mostrado');
}

// 10. FUNCIONES AUXILIARES MEJORADAS
function cerrarSesionMejorado() {
    console.log('üö™ Cerrando sesi√≥n...');
    
    // Limpiar datos de sesi√≥n
    window.usuarioActual = null;
    localStorage.removeItem('usuarioActual');
    
    // Mostrar mensaje
    mostrarMensaje('‚úÖ Sesi√≥n cerrada correctamente', 'success');
    
    // Recargar p√°gina despu√©s de un momento
    setTimeout(() => {
        location.reload();
    }, 1500);
}

function volverAlInicio() {
    console.log('üè† Volviendo al inicio...');
    location.reload();
}

// 11. FUNCI√ìN PARA MOSTRAR ESTAD√çSTICAS DEL SISTEMA
function mostrarEstadisticasSistema() {
    const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
    const materias = JSON.parse(localStorage.getItem('materias')) || [];
    const asistencias = JSON.parse(localStorage.getItem('asistencias')) || [];
    
    const stats = {
        usuarios: {
            total: usuarios.length,
            estudiantes: usuarios.filter(u => u.tipo === 'estudiante').length,
            profesores: usuarios.filter(u => u.tipo === 'profesor').length,
            administradores: usuarios.filter(u => u.tipo === 'administrador').length
        },
        materias: materias.length,
        asistencias: asistencias.length
    };
    
    console.log('üìä Estad√≠sticas del sistema:', stats);
    return stats;
}

// 11. CONFIGURAR BOTONES DE MODAL
function configurarBotonesModales() {
    // Botones para abrir modales
    const btnRegistro = document.getElementById('btnRegistro');
    const btnLogin = document.getElementById('btnLogin');
    
    if (btnRegistro) {
        btnRegistro.onclick = () => abrirModal('registroModal');
    }
    
    if (btnLogin) {
        btnLogin.onclick = () => abrirModal('loginModal');
    }
    
    // Botones para cerrar modales
    const closeButtons = document.querySelectorAll('.close');
    closeButtons.forEach(btn => {
        btn.onclick = (e) => {
            const modal = e.target.closest('.modal');
            if (modal) cerrarModal(modal.id);
        };
    });
    
    console.log('‚úÖ Botones de modal configurados');
}

function abrirModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
        console.log(`‚úÖ Modal ${modalId} abierto`);
    }
}

// 12. MOSTRAR ESTADO DEL SISTEMA
function mostrarEstadoSistema() {
    console.log('üìä === ESTADO DEL SISTEMA ===');
    
    const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
    console.log(`üë• Total usuarios: ${usuarios.length}`);
    
    usuarios.forEach((u, i) => {
        console.log(`   ${i + 1}. ${u.email} (${u.tipo})`);
    });
    
    const formularios = ['formEstudiante', 'formProfesor', 'loginForm'];
    formularios.forEach(id => {
        const form = document.getElementById(id);
        console.log(`üìù ${id}: ${form ? 'Encontrado' : 'NO encontrado'}`);
    });
    
    console.log('================================');
}

// 13. AUTO-INICIALIZACI√ìN
console.log('üöÄ Sistema de reparaci√≥n cargado');
console.log('üí° Ejecuta: forzarConfiguracionCompleta()');

// Hacer funciones disponibles globalmente
window.forzarConfiguracionCompleta = forzarConfiguracionCompleta;
window.cargarUsuariosDemo = cargarUsuariosDemo;
window.mostrarEstadoSistema = mostrarEstadoSistema;
window.procesarRegistroEstudiante = procesarRegistroEstudiante;
window.procesarRegistroProfesor = procesarRegistroProfesor;
window.procesarLogin = procesarLogin;
window.cerrarSesionMejorado = cerrarSesionMejorado;
window.mostrarDashboardMejorado = mostrarDashboardMejorado;
window.mostrarEstadisticasSistema = mostrarEstadisticasSistema;
window.volverAlInicio = volverAlInicio;

// Ejecutar autom√°ticamente cuando est√© listo
if (document.readyState === 'complete') {
    setTimeout(forzarConfiguracionCompleta, 1000);
} else {
    window.addEventListener('load', () => {
        setTimeout(forzarConfiguracionCompleta, 1000);
    });
}

console.log('üéØ === SISTEMA FIX CARGADO ===');
console.log('‚úÖ Registro separado por tipos de usuario');
console.log('‚úÖ NO inscripci√≥n autom√°tica a materias');
console.log('‚úÖ Validaciones mejoradas');
console.log('‚úÖ Dashboard espec√≠fico por tipo de usuario');
console.log('‚úÖ Sistema de administrador incluido');
console.log('');
console.log('üë• Usuarios demo disponibles:');
console.log('   üìß maria.hernandez@estudiante.demo.com / estudiante123 (Estudiante)');
console.log('   üìß laura.mendoza@profesor.demo.com / profesor123 (Profesor)');
console.log('   üìß admin@sistema.com / admin123 (Administrador)');
console.log('');
console.log('üîß Para debugging: mostrarEstadisticasSistema()');
