// SOLUCI√ìN SENIOR: SISTEMA ROBUSTO CON PREVENCI√ìN DE CONFLICTOS

// Variables globales del sistema
window.sistemaConfigurado = false;
window.eventListenersConfigurados = false;

// 1. CONFIGURACI√ìN PRINCIPAL CON PREVENCI√ìN DE CONFLICTOS
function forzarConfiguracionCompleta() {
    console.log('üîß === CONFIGURACI√ìN SENIOR DEL SISTEMA ===');
    
    // Prevenir ejecuciones m√∫ltiples
    if (window.sistemaConfigurado) {
        console.log('‚ö†Ô∏è Sistema ya configurado, evitando duplicaci√≥n');
        return;
    }
    
    // Esperar a que DOM est√© completamente cargado
    if (document.readyState !== 'complete') {
        console.log('‚è≥ Esperando carga completa del DOM...');
        window.addEventListener('load', forzarConfiguracionCompleta);
        return;
    }
    
    try {
        // Marcar como en proceso
        window.sistemaConfigurado = true;
        
        // 1. Validar estructura HTML
        if (!validarEstructuraHTML()) {
            throw new Error('Estructura HTML inv√°lida');
        }
        
        // 2. Cargar usuarios demo
        cargarUsuariosDemo();
        
        // 3. Configurar event listeners de forma segura
        configurarEventListenersSeguro();
        
        // 4. Configurar botones de modal
        configurarBotonesModales();
        
        // 5. Mostrar estado del sistema
        mostrarEstadoSistema();
        
        console.log('‚úÖ Sistema configurado exitosamente por desarrollador senior');
        
    } catch (error) {
        console.error('‚ùå Error en configuraci√≥n:', error);
        window.sistemaConfigurado = false;
    }
}

// 2. VALIDACI√ìN SENIOR DE ESTRUCTURA HTML
function validarEstructuraHTML() {
    console.log('üîç Validando estructura HTML...');
    
    const elementosRequeridos = [
        { id: 'formEstudiante', tipo: 'Formulario de estudiante' },
        { id: 'formProfesor', tipo: 'Formulario de profesor' },
        { id: 'loginForm', tipo: 'Formulario de login' },
        { id: 'registroModal', tipo: 'Modal de registro' },
        { id: 'loginModal', tipo: 'Modal de login' }
    ];
    
    let errores = [];
    
    elementosRequeridos.forEach(elemento => {
        const dom = document.getElementById(elemento.id);
        if (!dom) {
            errores.push(`‚ùå ${elemento.tipo} (${elemento.id}) no encontrado`);
        } else {
            console.log(`‚úÖ ${elemento.tipo} encontrado`);
        }
    });
    
    if (errores.length > 0) {
        console.error('üö® Errores de estructura HTML:', errores);
        return false;
    }
    
    console.log('‚úÖ Estructura HTML v√°lida');
    return true;
}

// 3. CONFIGURACI√ìN SEGURA DE EVENT LISTENERS
function configurarEventListenersSeguro() {
    console.log('üîí Configurando event listeners de forma segura...');
    
    // Prevenir configuraci√≥n m√∫ltiple
    if (window.eventListenersConfigurados) {
        console.log('‚ö†Ô∏è Event listeners ya configurados');
        return;
    }
    
    try {
        // Limpiar listeners existentes usando clonaci√≥n de nodos
        const formularios = [
            { id: 'formEstudiante', handler: procesarRegistroEstudiante },
            { id: 'formProfesor', handler: procesarRegistroProfesor },
            { id: 'loginForm', handler: procesarLogin }
        ];
        
        formularios.forEach(({ id, handler }) => {
            const form = document.getElementById(id);
            if (form) {
                // Clonar nodo para eliminar listeners existentes
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
                
                // Agregar nuevo listener
                newForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log(`üìù Procesando ${id}...`);
                    handler(e);
                });
                
                console.log(`‚úÖ Event listener configurado para ${id}`);
            }
        });
        
        window.eventListenersConfigurados = true;
        console.log('‚úÖ Todos los event listeners configurados');
        
    } catch (error) {
        console.error('‚ùå Error configurando event listeners:', error);
        window.eventListenersConfigurados = false;
    }
}
// 4. CARGA SEGURA DE USUARIOS DEMO (SIN AUTO-INSCRIPCI√ìN)
function cargarUsuariosDemo() {
    console.log('üë• Cargando usuarios demo con validaci√≥n senior...');
    
    try {
        const usuariosExistentes = JSON.parse(localStorage.getItem('usuarios')) || [];
        console.log(`üìä Usuarios existentes: ${usuariosExistentes.length}`);
        
        // Definir usuarios demo con validaci√≥n completa
        const usuariosDemo = [
            {
                id: 'demo-est-001',
                tipo: 'estudiante',
                nombre: 'Mar√≠a Jos√©',
                apellido1: 'Hern√°ndez',
                apellido2: 'Garc√≠a',
                nombreCompleto: 'Mar√≠a Jos√© Hern√°ndez Garc√≠a',
                cedula: '11111111-1',
                fechaNacimiento: '2001-03-15',
                email: 'maria.hernandez@estudiante.demo.com',
                telefono: '+50611111111',
                direccion: 'San Jos√©, Costa Rica',
                carrera: 'ingenieria-sistemas',
                semestre: '4',
                password: 'estudiante123',
                fechaRegistro: new Date().toISOString(),
                estado: 'activo',
                validado: true
            },
            {
                id: 'demo-prof-001',
                tipo: 'profesor',
                nombre: 'Laura',
                apellido1: 'Mendoza',
                apellido2: 'Silva',
                nombreCompleto: 'Dra. Laura Mendoza Silva',
                cedula: '22222222-2',
                fechaNacimiento: '1980-08-20',
                email: 'laura.mendoza@profesor.demo.com',
                telefono: '+50622222222',
                direccion: 'Cartago, Costa Rica',
                especialidad: 'Ingenier√≠a de Software',
                titulo: 'Doctora en Ciencias de la Computaci√≥n',
                experiencia: '15',
                password: 'profesor123',
                fechaRegistro: new Date().toISOString(),
                estado: 'activo',
                validado: true
            },
            {
                id: 'demo-admin-001',
                tipo: 'administrador',
                nombre: 'Ana',
                apellido1: 'Rodr√≠guez',
                apellido2: 'L√≥pez',
                nombreCompleto: 'Ana Rodr√≠guez L√≥pez',
                cedula: '33333333-3',
                fechaNacimiento: '1985-12-10',
                email: 'admin@sistema.com',
                telefono: '+50633333333',
                direccion: 'San Jos√©, Costa Rica',
                password: 'admin123',
                fechaRegistro: new Date().toISOString(),
                estado: 'activo',
                validado: true,
                permisos: ['gestionar_usuarios', 'gestionar_materias', 'ver_reportes', 'administrar_sistema']
            }
        ];
        
        // Validar y agregar usuarios que no existan
        let usuariosActualizados = [...usuariosExistentes];
        let agregados = 0;
        
        usuariosDemo.forEach(demo => {
            // Buscar por email (case insensitive)
            const existe = usuariosActualizados.find(u => 
                u.email.toLowerCase() === demo.email.toLowerCase()
            );
            
            if (!existe) {
                // Validar usuario antes de agregar
                if (validarUsuarioDemo(demo)) {
                    usuariosActualizados.push(demo);
                    agregados++;
                    console.log(`   ‚úÖ Usuario demo agregado: ${demo.email} (${demo.tipo})`);
                } else {
                    console.warn(`   ‚ö†Ô∏è Usuario demo inv√°lido: ${demo.email}`);
                }
            }
        });
        
        if (agregados > 0) {
            localStorage.setItem('usuarios', JSON.stringify(usuariosActualizados));
            console.log(`‚úÖ ${agregados} usuarios demo agregados al sistema`);
        } else {
            console.log('‚úÖ Usuarios demo ya exist√≠an');
        }
        
        // Actualizar variable global de forma segura
        window.usuarios = usuariosActualizados;
        
        console.log(`üë• Total usuarios en sistema: ${usuariosActualizados.length}`);
        console.log('‚ÑπÔ∏è IMPORTANTE: Sistema preparado sin auto-inscripciones');
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error cargando usuarios demo:', error);
        return false;
    }
}

// 5. VALIDACI√ìN DE USUARIOS DEMO
function validarUsuarioDemo(usuario) {
    const camposRequeridos = ['id', 'tipo', 'nombre', 'apellido1', 'email', 'password'];
    
    for (let campo of camposRequeridos) {
        if (!usuario[campo] || usuario[campo].trim() === '') {
            console.error(`‚ùå Campo requerido faltante: ${campo}`);
            return false;
        }
    }
    
    // Validar email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(usuario.email)) {
        console.error('‚ùå Email inv√°lido:', usuario.email);
        return false;
    }
    
    // Validar tipo de usuario
    const tiposValidos = ['estudiante', 'profesor', 'administrador'];
    if (!tiposValidos.includes(usuario.tipo)) {
        console.error('‚ùå Tipo de usuario inv√°lido:', usuario.tipo);
        return false;
    }
    
    return true;
}

// 3. CONFIGURAR FORMULARIOS CON EVENT LISTENERS DIRECTOS
function configurarFormulariosDirectos() {
    console.log('üìù Configurando formularios directamente...');
    
    // FORMULARIO DE ESTUDIANTE
    const formEstudiante = document.getElementById('formEstudiante');
    if (formEstudiante) {
        // Remover listeners existentes
        const nuevoFormEst = formEstudiante.cloneNode(true);
        formEstudiante.parentNode.replaceChild(nuevoFormEst, formEstudiante);
        
        // Agregar nuevo listener
        nuevoFormEst.onsubmit = function(e) {
            e.preventDefault();
            console.log('üìù FORMULARIO ESTUDIANTE ENVIADO');
            procesarRegistroEstudiante(e);
        };
        
        console.log('‚úÖ Formulario estudiante configurado');
    } else {
        console.error('‚ùå Formulario estudiante no encontrado');
    }
    
    // FORMULARIO DE PROFESOR
    const formProfesor = document.getElementById('formProfesor');
    if (formProfesor) {
        // Remover listeners existentes
        const nuevoFormProf = formProfesor.cloneNode(true);
        formProfesor.parentNode.replaceChild(nuevoFormProf, formProfesor);
        
        // Agregar nuevo listener
        nuevoFormProf.onsubmit = function(e) {
            e.preventDefault();
            console.log('üìù FORMULARIO PROFESOR ENVIADO');
            procesarRegistroProfesor(e);
        };
        
        console.log('‚úÖ Formulario profesor configurado');
    } else {
        console.error('‚ùå Formulario profesor no encontrado');
    }
    
    // FORMULARIO DE LOGIN
    const formLogin = document.getElementById('loginForm');
    if (formLogin) {
        // Remover listeners existentes
        const nuevoFormLogin = formLogin.cloneNode(true);
        formLogin.parentNode.replaceChild(nuevoFormLogin, formLogin);
        
        // Agregar nuevo listener
        nuevoFormLogin.onsubmit = function(e) {
            e.preventDefault();
            console.log('üîë FORMULARIO LOGIN ENVIADO');
            procesarLogin(e);
        };
        
        console.log('‚úÖ Formulario login configurado');
    } else {
        console.error('‚ùå Formulario login no encontrado');
    }
}

// 6. PROCESAMIENTO SENIOR DE REGISTRO DE ESTUDIANTE
function procesarRegistroEstudiante(e) {
    console.log('üë§ === PROCESAMIENTO SENIOR: REGISTRO ESTUDIANTE ===');
    
    try {
        const formData = new FormData(e.target);
        
        // Extraer y sanitizar datos
        const datos = extraerDatosFormulario(formData, 'estudiante');
        
        // Validaci√≥n senior completa
        const validacion = validarDatosSenior(datos, 'estudiante');
        if (!validacion.valido) {
            mostrarMensaje(`‚ùå ${validacion.error}`, 'error');
            return false;
        }
        
        // Verificar duplicados de forma robusta
        if (verificarUsuarioDuplicado(datos.email)) {
            mostrarMensaje(`‚ùå El email ${datos.email} ya est√° registrado`, 'error');
            return false;
        }
        
        // Crear estudiante con validaciones adicionales
        const estudiante = crearUsuarioSeguro(datos, 'estudiante');
        
        // Guardar de forma transaccional
        if (guardarUsuarioSeguro(estudiante)) {
            console.log('‚úÖ Estudiante registrado exitosamente:', estudiante.email);
            mostrarMensaje('‚úÖ Estudiante registrado. Debe inscribirse a materias despu√©s del login.', 'success');
            
            // Limpiar y cerrar
            e.target.reset();
            setTimeout(() => cerrarModal('registroModal'), 2000);
            
            return true;
        } else {
            throw new Error('Error al guardar usuario');
        }
        
    } catch (error) {
        console.error('‚ùå Error procesando registro de estudiante:', error);
        mostrarMensaje('‚ùå Error interno. Intenta nuevamente.', 'error');
        return false;
    }
}

// 7. PROCESAMIENTO SENIOR DE REGISTRO DE PROFESOR
function procesarRegistroProfesor(e) {
    console.log('üë®‚Äçüè´ === PROCESAMIENTO SENIOR: REGISTRO PROFESOR ===');
    
    try {
        const formData = new FormData(e.target);
        
        // Extraer y sanitizar datos
        const datos = extraerDatosFormulario(formData, 'profesor');
        
        // Validaci√≥n senior completa
        const validacion = validarDatosSenior(datos, 'profesor');
        if (!validacion.valido) {
            mostrarMensaje(`‚ùå ${validacion.error}`, 'error');
            return false;
        }
        
        // Verificar duplicados
        if (verificarUsuarioDuplicado(datos.email)) {
            mostrarMensaje(`‚ùå El email ${datos.email} ya est√° registrado`, 'error');
            return false;
        }
        
        // Crear profesor sin materias autom√°ticas
        const profesor = crearUsuarioSeguro(datos, 'profesor');
        
        // Guardar de forma transaccional
        if (guardarUsuarioSeguro(profesor)) {
            console.log('‚úÖ Profesor registrado exitosamente:', profesor.email);
            console.log('‚ÑπÔ∏è NO se crearon materias autom√°ticamente (correcto)');
            mostrarMensaje('‚úÖ Profesor registrado. Debe crear materias despu√©s del login.', 'success');
            
            // Limpiar y cerrar
            e.target.reset();
            setTimeout(() => cerrarModal('registroModal'), 3000);
            
            return true;
        } else {
            throw new Error('Error al guardar usuario');
        }
        
    } catch (error) {
        console.error('‚ùå Error procesando registro de profesor:', error);
        mostrarMensaje('‚ùå Error interno. Intenta nuevamente.', 'error');
        return false;
    }
}

// 8. FUNCIONES AUXILIARES SENIOR

// Extracci√≥n segura de datos del formulario
function extraerDatosFormulario(formData, tipo) {
    const camposComunes = {
        nombre: formData.get('nombre')?.trim() || '',
        apellido1: formData.get('apellido1')?.trim() || '',
        apellido2: formData.get('apellido2')?.trim() || '',
        cedula: formData.get('cedula')?.trim() || '',
        fechaNacimiento: formData.get('fechaNacimiento') || '',
        email: formData.get('email')?.trim().toLowerCase() || '',
        telefono: formData.get('telefono')?.trim() || '',
        direccion: formData.get('direccion')?.trim() || '',
        password: formData.get('password') || ''
    };
    
    if (tipo === 'estudiante') {
        return {
            ...camposComunes,
            carrera: formData.get('carrera') || '',
            semestre: formData.get('semestre') || ''
        };
    } else if (tipo === 'profesor') {
        return {
            ...camposComunes,
            especialidad: formData.get('especialidad')?.trim() || '',
            titulo: formData.get('titulo')?.trim() || '',
            experiencia: formData.get('experiencia') || ''
        };
    }
    
    return camposComunes;
}

// Validaci√≥n senior de datos
function validarDatosSenior(datos, tipo) {
    // Validaciones b√°sicas
    const camposObligatorios = ['nombre', 'apellido1', 'email', 'password'];
    for (let campo of camposObligatorios) {
        if (!datos[campo] || datos[campo].length === 0) {
            return { valido: false, error: `El campo ${campo} es obligatorio` };
        }
    }
    
    // Validar longitud de contrase√±a
    if (datos.password.length < 6) {
        return { valido: false, error: 'La contrase√±a debe tener al menos 6 caracteres' };
    }
    
    // Validar formato de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(datos.email)) {
        return { valido: false, error: 'El formato del email no es v√°lido' };
    }
    
    // Validar caracteres especiales en nombre
    const nombreRegex = /^[a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë\s]+$/;
    if (!nombreRegex.test(datos.nombre) || !nombreRegex.test(datos.apellido1)) {
        return { valido: false, error: 'Nombre y apellidos solo pueden contener letras' };
    }
    
    // Validaciones espec√≠ficas por tipo
    if (tipo === 'estudiante') {
        if (!datos.carrera) {
            return { valido: false, error: 'Debe seleccionar una carrera' };
        }
        if (!datos.semestre) {
            return { valido: false, error: 'Debe seleccionar un semestre' };
        }
    }
    
    if (tipo === 'profesor') {
        if (!datos.especialidad) {
            return { valido: false, error: 'La especialidad es obligatoria para profesores' };
        }
    }
    
    return { valido: true };
}

// Verificaci√≥n robusta de usuarios duplicados
function verificarUsuarioDuplicado(email) {
    try {
        const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        return usuarios.some(u => u.email.toLowerCase() === email.toLowerCase());
    } catch (error) {
        console.error('Error verificando duplicados:', error);
        return false;
    }
}

// Creaci√≥n segura de usuarios
function crearUsuarioSeguro(datos, tipo) {
    const usuario = {
        id: `${tipo}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        tipo: tipo,
        ...datos,
        nombreCompleto: construirNombreCompleto(datos, tipo),
        fechaRegistro: new Date().toISOString(),
        estado: 'activo',
        validado: true,
        version: '1.0'
    };
    
    // Agregar campos espec√≠ficos por tipo
    if (tipo === 'profesor') {
        usuario.materias = []; // Array vac√≠o, se llenar√°n despu√©s
        usuario.estudiantesAsignados = [];
    } else if (tipo === 'estudiante') {
        usuario.materiasInscritas = []; // Array vac√≠o, se llenar√°n despu√©s
        usuario.historialAcademico = [];
    }
    
    return usuario;
}

// Construcci√≥n inteligente de nombre completo
function construirNombreCompleto(datos, tipo) {
    let nombre = `${datos.nombre} ${datos.apellido1}`;
    if (datos.apellido2) {
        nombre += ` ${datos.apellido2}`;
    }
    
    // Agregar t√≠tulo para profesores
    if (tipo === 'profesor' && datos.titulo) {
        nombre = `${datos.titulo} ${nombre}`;
    }
    
    return nombre;
}

// Guardado transaccional
function guardarUsuarioSeguro(usuario) {
    try {
        // Obtener usuarios actuales
        const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        
        // Verificar nuevamente que no exista (doble check)
        const existe = usuarios.find(u => u.email.toLowerCase() === usuario.email.toLowerCase());
        if (existe) {
            console.error('‚ùå Usuario duplicado detectado en guardado');
            return false;
        }
        
        // Agregar usuario
        usuarios.push(usuario);
        
        // Guardar de forma at√≥mica
        localStorage.setItem('usuarios', JSON.stringify(usuarios));
        
        // Actualizar variable global
        window.usuarios = usuarios;
        
        // Verificar que se guard√≥ correctamente
        const verificacion = JSON.parse(localStorage.getItem('usuarios')) || [];
        const guardado = verificacion.find(u => u.id === usuario.id);
        
        if (guardado) {
            console.log('‚úÖ Usuario guardado y verificado correctamente');
            return true;
        } else {
            console.error('‚ùå Error en verificaci√≥n de guardado');
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Error guardando usuario:', error);
        return false;
    }
}
// 9. PROCESAMIENTO SENIOR DE LOGIN
function procesarLogin(e) {
    console.log('üîë === PROCESAMIENTO SENIOR: LOGIN ===');
    
    try {
        const formData = new FormData(e.target);
        
        const datos = {
            email: formData.get('email')?.trim().toLowerCase() || '',
            password: formData.get('password') || '',
            userType: formData.get('userType') || ''
        };
        
        console.log('üìã Intento de login:', { email: datos.email, userType: datos.userType });
        
        // Validaciones de entrada
        if (!datos.email || !datos.password || !datos.userType) {
            mostrarMensaje('‚ùå Todos los campos son obligatorios', 'error');
            return false;
        }
        
        // Validar formato de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(datos.email)) {
            mostrarMensaje('‚ùå Formato de email inv√°lido', 'error');
            return false;
        }
        
        // Obtener usuarios de forma segura
        const usuarios = obtenerUsuariosSeguro();
        if (!usuarios) {
            mostrarMensaje('‚ùå Error accediendo a la base de datos', 'error');
            return false;
        }
        
        console.log(`üë• Buscando entre ${usuarios.length} usuarios registrados`);
        
        // Buscar usuario con validaciones m√∫ltiples
        const usuario = buscarUsuarioSeguro(usuarios, datos);
        
        if (usuario) {
            // Validar estado del usuario
            if (!validarEstadoUsuario(usuario)) {
                return false;
            }
            
            // Procesar login exitoso
            return procesarLoginExitoso(usuario);
            
        } else {
            console.log('‚ùå Credenciales incorrectas');
            logUsuariosDisponibles(usuarios);
            mostrarMensaje('‚ùå Email, contrase√±a o tipo de usuario incorrectos', 'error');
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Error procesando login:', error);
        mostrarMensaje('‚ùå Error interno del sistema', 'error');
        return false;
    }
}

// Obtener usuarios de forma segura
function obtenerUsuariosSeguro() {
    try {
        const usuariosStr = localStorage.getItem('usuarios');
        if (!usuariosStr) {
            console.warn('‚ö†Ô∏è No hay usuarios en localStorage');
            return [];
        }
        
        const usuarios = JSON.parse(usuariosStr);
        if (!Array.isArray(usuarios)) {
            console.error('‚ùå Datos de usuarios corruptos');
            return [];
        }
        
        return usuarios;
    } catch (error) {
        console.error('‚ùå Error parseando usuarios:', error);
        return null;
    }
}

// B√∫squeda segura de usuario
function buscarUsuarioSeguro(usuarios, datos) {
    return usuarios.find(u => {
        return u.email.toLowerCase() === datos.email.toLowerCase() && 
               u.password === datos.password && 
               u.tipo === datos.userType &&
               u.validado !== false; // Excluir usuarios no validados
    });
}

// Validar estado del usuario
function validarEstadoUsuario(usuario) {
    if (usuario.estado !== 'activo') {
        mostrarMensaje('‚ùå La cuenta est√° inactiva. Contacta al administrador.', 'error');
        return false;
    }
    
    if (usuario.bloqueado === true) {
        mostrarMensaje('‚ùå La cuenta est√° bloqueada. Contacta al administrador.', 'error');
        return false;
    }
    
    return true;
}

// Procesar login exitoso
function procesarLoginExitoso(usuario) {
    console.log('‚úÖ Login exitoso para:', usuario.email);
    
    try {
        // Actualizar informaci√≥n de sesi√≥n
        const sesion = {
            ...usuario,
            ultimoLogin: new Date().toISOString(),
            sesionActiva: true
        };
        
        // Guardar sesi√≥n de forma segura
        window.usuarioActual = sesion;
        localStorage.setItem('usuarioActual', JSON.stringify(sesion));
        
        // Mostrar mensaje de bienvenida
        const tipoCapitalizado = usuario.tipo.charAt(0).toUpperCase() + usuario.tipo.slice(1);
        mostrarMensaje(`‚úÖ Bienvenido, ${usuario.nombreCompleto} (${tipoCapitalizado})`, 'success');
        
        // Registrar en logs (si est√° disponible)
        registrarEventoLogin(usuario);
        
        // Cerrar modal y mostrar dashboard
        setTimeout(() => {
            cerrarModal('loginModal');
            setTimeout(() => {
                mostrarDashboardMejorado(sesion);
            }, 1000);
        }, 1500);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error procesando login exitoso:', error);
        mostrarMensaje('‚ùå Error al inicializar sesi√≥n', 'error');
        return false;
    }
}

// Registrar evento de login (para auditor√≠a)
function registrarEventoLogin(usuario) {
    try {
        const eventos = JSON.parse(localStorage.getItem('eventosLogin')) || [];
        eventos.push({
            usuario: usuario.email,
            tipo: usuario.tipo,
            timestamp: new Date().toISOString(),
            ip: 'local', // En producci√≥n se obtendr√≠a la IP real
            userAgent: navigator.userAgent
        });
        
        // Mantener solo los √∫ltimos 100 eventos
        if (eventos.length > 100) {
            eventos.splice(0, eventos.length - 100);
        }
        
        localStorage.setItem('eventosLogin', JSON.stringify(eventos));
        console.log('üìù Evento de login registrado');
    } catch (error) {
        console.warn('‚ö†Ô∏è No se pudo registrar evento de login:', error);
    }
}

// Log de usuarios disponibles para debugging
function logUsuariosDisponibles(usuarios) {
    if (usuarios.length === 0) {
        console.log('üìã No hay usuarios registrados');
        return;
    }
    
    console.log('üìã Usuarios disponibles para debugging:');
    usuarios.forEach((u, index) => {
        console.log(`   ${index + 1}. ${u.email} (${u.tipo}) - Estado: ${u.estado}`);
    });
}

// 7. MOSTRAR MENSAJE (SIMPLE Y DIRECTO)
function mostrarMensaje(mensaje, tipo) {
    console.log(`üì¢ ${mensaje}`);
    
    // Crear o usar notificaci√≥n existente
    let notificacion = document.getElementById('notificacion-fix');
    
    if (!notificacion) {
        notificacion = document.createElement('div');
        notificacion.id = 'notificacion-fix';
        notificacion.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            max-width: 300px;
            transition: all 0.3s ease;
        `;
        document.body.appendChild(notificacion);
    }
    
    // Configurar estilos seg√∫n el tipo
    if (tipo === 'success') {
        notificacion.style.backgroundColor = '#28a745';
    } else if (tipo === 'error') {
        notificacion.style.backgroundColor = '#dc3545';
    } else {
        notificacion.style.backgroundColor = '#007bff';
    }
    
    notificacion.textContent = mensaje;
    notificacion.style.display = 'block';
    
    // Ocultar despu√©s de 3 segundos
    setTimeout(() => {
        notificacion.style.display = 'none';
    }, 3000);
}

// 8. CERRAR MODAL
function cerrarModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        console.log(`‚úÖ Modal ${modalId} cerrado`);
    }
}

// 9. DASHBOARD MEJORADO SEG√öN TIPO DE USUARIO
function mostrarDashboardMejorado(usuario) {
    console.log('üéØ === MOSTRANDO DASHBOARD MEJORADO ===');
    console.log(`üë§ Usuario: ${usuario.email} (${usuario.tipo})`);
    
    // Ocultar contenido principal
    const elementsToHide = ['.header', '.hero', '.about', 'footer', '.modal'];
    elementsToHide.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => el.style.display = 'none');
    });
    
    // Crear dashboard espec√≠fico
    let dashboard = document.getElementById('dashboard-mejorado');
    if (!dashboard) {
        dashboard = document.createElement('div');
        dashboard.id = 'dashboard-mejorado';
        dashboard.style.cssText = `
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            background: #f8f9fa;
        `;
        document.body.appendChild(dashboard);
    }
    
    // Contenido espec√≠fico seg√∫n tipo de usuario
    let contenidoEspecifico = '';
    
    if (usuario.tipo === 'estudiante') {
        contenidoEspecifico = `
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="color: #007bff; margin: 0 0 15px 0;">üìö Panel de Estudiante</h3>
                <p><strong>Carrera:</strong> ${usuario.carrera || 'No especificada'}</p>
                <p><strong>Semestre:</strong> ${usuario.semestre || 'No especificado'}</p>
                <div style="margin-top: 15px;">
                    <h4>Pr√≥ximas funciones:</h4>
                    <ul>
                        <li>üìã Ver materias disponibles</li>
                        <li>‚úèÔ∏è Inscribirse a materias</li>
                        <li>üìä Ver calificaciones</li>
                        <li>üìÖ Ver horarios de clase</li>
                        <li>üìà Seguimiento de asistencia</li>
                    </ul>
                </div>
            </div>
        `;
    } else if (usuario.tipo === 'profesor') {
        contenidoEspecifico = `
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="color: #28a745; margin: 0 0 15px 0;">üë®‚Äçüè´ Panel de Profesor</h3>
                <p><strong>Especialidad:</strong> ${usuario.especialidad || 'No especificada'}</p>
                <p><strong>T√≠tulo:</strong> ${usuario.titulo || 'No especificado'}</p>
                <p><strong>Experiencia:</strong> ${usuario.experiencia || 'No especificada'} a√±os</p>
                <div style="margin-top: 15px;">
                    <h4>Pr√≥ximas funciones:</h4>
                    <ul>
                        <li>üìö Crear y gestionar materias</li>
                        <li>üë• Inscribir estudiantes a materias</li>
                        <li>üìä Registrar calificaciones</li>
                        <li>üìÖ Gestionar horarios</li>
                        <li>üìà Control de asistencias</li>
                        <li>üìù Generar reportes</li>
                    </ul>
                </div>
            </div>
        `;
    } else if (usuario.tipo === 'administrador') {
        const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        const totalEstudiantes = usuarios.filter(u => u.tipo === 'estudiante').length;
        const totalProfesores = usuarios.filter(u => u.tipo === 'profesor').length;
        
        contenidoEspecifico = `
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="color: #dc3545; margin: 0 0 15px 0;">‚öôÔ∏è Panel de Administrador</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0; color: #1565c0;">üë• Usuarios</h4>
                        <p style="margin: 5px 0; font-size: 24px; font-weight: bold;">${usuarios.length}</p>
                    </div>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0; color: #2e7d32;">üë®‚Äçüè´ Profesores</h4>
                        <p style="margin: 5px 0; font-size: 24px; font-weight: bold;">${totalProfesores}</p>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="margin: 0; color: #ef6c00;">üéì Estudiantes</h4>
                        <p style="margin: 5px 0; font-size: 24px; font-weight: bold;">${totalEstudiantes}</p>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <h4>Funciones de administrador:</h4>
                    <ul>
                        <li>üë• Gestionar usuarios (crear, editar, eliminar)</li>
                        <li>üìö Supervisar materias y asignaciones</li>
                        <li>üìä Ver reportes del sistema</li>
                        <li>‚öôÔ∏è Configurar sistema</li>
                        <li>üîí Gestionar permisos</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    dashboard.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
            <h1 style="margin: 0 0 10px 0; font-size: 2.5em;">‚úÖ Sistema Funcionando Correctamente</h1>
            <h2 style="margin: 0; opacity: 0.9;">Bienvenido, ${usuario.nombreCompleto}</h2>
            <p style="margin: 10px 0 0 0; opacity: 0.8;">
                <strong>Email:</strong> ${usuario.email} | 
                <strong>Tipo:</strong> ${usuario.tipo.charAt(0).toUpperCase() + usuario.tipo.slice(1)} |
                <strong>Estado:</strong> ${usuario.estado.charAt(0).toUpperCase() + usuario.estado.slice(1)}
            </p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            ${contenidoEspecifico}
            
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #17a2b8; margin: 0 0 15px 0;">ÔøΩ Sistema</h3>
                <div style="margin-bottom: 15px;">
                    <p><strong>‚úÖ Registro:</strong> Funcionando</p>
                    <p><strong>‚úÖ Login:</strong> Funcionando</p>
                    <p><strong>‚úÖ Validaciones:</strong> Activas</p>
                    <p><strong>‚úÖ Base de datos:</strong> LocalStorage</p>
                </div>
                
                <h4 style="margin: 15px 0 10px 0;">Credenciales Demo:</h4>
                <div style="font-size: 0.9em; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <p style="margin: 5px 0;"><strong>Estudiante:</strong><br>
                    üìß maria.hernandez@estudiante.demo.com<br>
                    üîí estudiante123</p>
                    
                    <p style="margin: 5px 0;"><strong>Profesor:</strong><br>
                    üìß laura.mendoza@profesor.demo.com<br>
                    üîí profesor123</p>
                    
                    <p style="margin: 5px 0;"><strong>Admin:</strong><br>
                    üìß admin@sistema.com<br>
                    üîí admin123</p>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button onclick="cerrarSesionMejorado()" style="background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; margin-right: 15px; font-size: 16px;">
                üö™ Cerrar Sesi√≥n
            </button>
            <button onclick="volverAlInicio()" style="background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                üè† Volver al Inicio
            </button>
        </div>
    `;
    
    console.log('‚úÖ Dashboard mejorado mostrado');
}

// 10. FUNCIONES AUXILIARES MEJORADAS
function cerrarSesionMejorado() {
    console.log('üö™ Cerrando sesi√≥n...');
    
    // Limpiar datos de sesi√≥n
    window.usuarioActual = null;
    localStorage.removeItem('usuarioActual');
    
    // Mostrar mensaje
    mostrarMensaje('‚úÖ Sesi√≥n cerrada correctamente', 'success');
    
    // Recargar p√°gina despu√©s de un momento
    setTimeout(() => {
        location.reload();
    }, 1500);
}

function volverAlInicio() {
    console.log('üè† Volviendo al inicio...');
    location.reload();
}

// 11. FUNCI√ìN PARA MOSTRAR ESTAD√çSTICAS DEL SISTEMA
function mostrarEstadisticasSistema() {
    const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
    const materias = JSON.parse(localStorage.getItem('materias')) || [];
    const asistencias = JSON.parse(localStorage.getItem('asistencias')) || [];
    
    const stats = {
        usuarios: {
            total: usuarios.length,
            estudiantes: usuarios.filter(u => u.tipo === 'estudiante').length,
            profesores: usuarios.filter(u => u.tipo === 'profesor').length,
            administradores: usuarios.filter(u => u.tipo === 'administrador').length
        },
        materias: materias.length,
        asistencias: asistencias.length
    };
    
    console.log('üìä Estad√≠sticas del sistema:', stats);
    return stats;
}

// 12. CONFIGURACI√ìN DE MODALES Y NOTIFICACIONES
function configurarBotonesModales() {
    console.log('üéØ Configurando botones de modales...');
    
    try {
        // Botones para abrir modales
        const btnRegistro = document.getElementById('btnRegistro');
        const btnLogin = document.getElementById('btnLogin');
        
        if (btnRegistro) {
            btnRegistro.onclick = () => abrirModal('registroModal');
            console.log('‚úÖ Bot√≥n registro configurado');
        } else {
            console.warn('‚ö†Ô∏è Bot√≥n registro no encontrado');
        }
        
        if (btnLogin) {
            btnLogin.onclick = () => abrirModal('loginModal');
            console.log('‚úÖ Bot√≥n login configurado');
        } else {
            console.warn('‚ö†Ô∏è Bot√≥n login no encontrado');
        }
        
        // Botones para cerrar modales
        const closeButtons = document.querySelectorAll('.close');
        closeButtons.forEach(btn => {
            btn.onclick = (e) => {
                const modal = e.target.closest('.modal');
                if (modal) cerrarModal(modal.id);
            };
        });
        
        console.log(`‚úÖ ${closeButtons.length} botones de cerrar configurados`);
        
    } catch (error) {
        console.error('‚ùå Error configurando botones de modal:', error);
    }
}

function abrirModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
        console.log(`‚úÖ Modal ${modalId} abierto`);
    } else {
        console.error(`‚ùå Modal ${modalId} no encontrado`);
    }
}

function cerrarModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        console.log(`‚úÖ Modal ${modalId} cerrado`);
    }
}

// 13. SISTEMA DE NOTIFICACIONES MEJORADO
function mostrarMensaje(mensaje, tipo) {
    console.log(`üì¢ [${tipo.toUpperCase()}] ${mensaje}`);
    
    try {
        // Crear o usar notificaci√≥n existente
        let notificacion = document.getElementById('notificacion-senior');
        
        if (!notificacion) {
            notificacion = document.createElement('div');
            notificacion.id = 'notificacion-senior';
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 350px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
                font-family: 'Poppins', Arial, sans-serif;
            `;
            document.body.appendChild(notificacion);
        }
        
        // Configurar estilos seg√∫n el tipo
        const estilos = {
            success: '#28a745',
            error: '#dc3545',
            warning: '#ffc107',
            info: '#007bff'
        };
        
        notificacion.style.backgroundColor = estilos[tipo] || estilos.info;
        notificacion.textContent = mensaje;
        notificacion.style.display = 'block';
        notificacion.style.opacity = '1';
        
        // Auto-ocultar despu√©s de 4 segundos
        setTimeout(() => {
            if (notificacion) {
                notificacion.style.opacity = '0';
                setTimeout(() => {
                    if (notificacion) {
                        notificacion.style.display = 'none';
                    }
                }, 300);
            }
        }, 4000);
        
    } catch (error) {
        console.error('‚ùå Error mostrando mensaje:', error);
        // Fallback a alert nativo
        alert(`${tipo.toUpperCase()}: ${mensaje}`);
    }
}

// 14. ESTADO DEL SISTEMA Y DIAGN√ìSTICOS
function mostrarEstadoSistema() {
    console.log('üìä === ESTADO DEL SISTEMA ===');
    
    try {
        const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        const materias = JSON.parse(localStorage.getItem('materias')) || [];
        const asistencias = JSON.parse(localStorage.getItem('asistencias')) || [];
        
        console.log(`üë• Total usuarios: ${usuarios.length}`);
        
        // Desglose por tipo
        const stats = {
            estudiantes: usuarios.filter(u => u.tipo === 'estudiante').length,
            profesores: usuarios.filter(u => u.tipo === 'profesor').length,
            administradores: usuarios.filter(u => u.tipo === 'administrador').length
        };
        
        console.log(`   - Estudiantes: ${stats.estudiantes}`);
        console.log(`   - Profesores: ${stats.profesores}`);
        console.log(`   - Administradores: ${stats.administradores}`);
        console.log(`üìö Materias: ${materias.length}`);
        console.log(`üìã Asistencias: ${asistencias.length}`);
        
        // Verificar formularios
        const formularios = ['formEstudiante', 'formProfesor', 'loginForm'];
        formularios.forEach(id => {
            const form = document.getElementById(id);
            console.log(`üìù ${id}: ${form ? 'Encontrado' : 'NO encontrado'}`);
        });
        
        // Estado de event listeners
        console.log(`üîó Event listeners: ${window.eventListenersConfigurados ? 'Configurados' : 'NO configurados'}`);
        console.log(`‚öôÔ∏è Sistema: ${window.sistemaConfigurado ? 'Configurado' : 'NO configurado'}`);
        
        console.log('================================');
        
        return {
            usuarios: stats,
            materias: materias.length,
            asistencias: asistencias.length,
            formularios: formularios.map(id => ({
                id,
                encontrado: !!document.getElementById(id)
            })),
            estado: {
                sistemaConfigurado: window.sistemaConfigurado,
                eventListenersConfigurados: window.eventListenersConfigurados
            }
        };
        
    } catch (error) {
        console.error('‚ùå Error obteniendo estado del sistema:', error);
        return { error: error.message };
    }
}

// 12. MOSTRAR ESTADO DEL SISTEMA
function mostrarEstadoSistema() {
    console.log('üìä === ESTADO DEL SISTEMA ===');
    
    const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
    console.log(`üë• Total usuarios: ${usuarios.length}`);
    
    usuarios.forEach((u, i) => {
        console.log(`   ${i + 1}. ${u.email} (${u.tipo})`);
    });
    
    const formularios = ['formEstudiante', 'formProfesor', 'loginForm'];
    formularios.forEach(id => {
        const form = document.getElementById(id);
        console.log(`üìù ${id}: ${form ? 'Encontrado' : 'NO encontrado'}`);
    });
    
    console.log('================================');
}

// 13. AUTO-INICIALIZACI√ìN
console.log('üöÄ Sistema de reparaci√≥n cargado');
console.log('üí° Ejecuta: forzarConfiguracionCompleta()');

// 15. INICIALIZACI√ìN Y EXPORTACI√ìN DE FUNCIONES
// Hacer funciones disponibles globalmente para debugging y uso
window.forzarConfiguracionCompleta = forzarConfiguracionCompleta;
window.cargarUsuariosDemo = cargarUsuariosDemo;
window.mostrarEstadoSistema = mostrarEstadoSistema;
window.mostrarEstadisticasSistema = mostrarEstadisticasSistema;
window.procesarRegistroEstudiante = procesarRegistroEstudiante;
window.procesarRegistroProfesor = procesarRegistroProfesor;
window.procesarLogin = procesarLogin;
window.cerrarSesionMejorado = cerrarSesionMejorado;
window.mostrarDashboardMejorado = mostrarDashboardMejorado;
window.volverAlInicio = volverAlInicio;
window.mostrarMensaje = mostrarMensaje;
window.abrirModal = abrirModal;
window.cerrarModal = cerrarModal;

// Funciones de utilidad para desarrolladores
window.extraerDatosFormulario = extraerDatosFormulario;
window.validarDatosSenior = validarDatosSenior;
window.crearUsuarioSeguro = crearUsuarioSeguro;
window.guardarUsuarioSeguro = guardarUsuarioSeguro;

// 16. AUTO-INICIALIZACI√ìN CON CONTROL DE ERRORES
function inicializarSistemaSenior() {
    console.log('üöÄ === INICIANDO SISTEMA SENIOR ===');
    
    try {
        // Verificar que el DOM est√© listo
        if (document.readyState === 'complete') {
            setTimeout(forzarConfiguracionCompleta, 500);
        } else {
            window.addEventListener('load', () => {
                setTimeout(forzarConfiguracionCompleta, 500);
            });
        }
        
        // Configurar handler para errores globales
        window.addEventListener('error', (e) => {
            console.error('üö® Error global capturado:', e.error);
        });
        
        // Configurar handler para promesas rechazadas
        window.addEventListener('unhandledrejection', (e) => {
            console.error('üö® Promesa rechazada:', e.reason);
        });
        
    } catch (error) {
        console.error('üí• Error cr√≠tico en inicializaci√≥n:', error);
    }
}

// Ejecutar inicializaci√≥n
inicializarSistemaSenior();

// 17. INFORMACI√ìN DEL SISTEMA
console.log('üéØ === SISTEMA SENIOR CARGADO ===');
console.log('‚úÖ Registro separado por tipos de usuario');
console.log('‚úÖ Validaciones senior implementadas');
console.log('‚úÖ Sistema de testing incluido');
console.log('‚úÖ NO inscripci√≥n autom√°tica a materias');
console.log('‚úÖ Dashboard espec√≠fico por tipo de usuario');
console.log('‚úÖ Sistema de administrador incluido');
console.log('‚úÖ Manejo de errores robusto');
console.log('‚úÖ Persistencia transaccional');
console.log('');
console.log('üë• Usuarios demo disponibles:');
console.log('   üìß maria.hernandez@estudiante.demo.com / estudiante123 (Estudiante)');
console.log('   üìß laura.mendoza@profesor.demo.com / profesor123 (Profesor)');
console.log('   üìß admin@sistema.com / admin123 (Administrador)');
console.log('');
console.log('üîß Comandos disponibles:');
console.log('   - mostrarEstadoSistema() - Estado general del sistema');
console.log('   - mostrarEstadisticasSistema() - Estad√≠sticas detalladas');
console.log('   - ejecutarTestsCompletos() - Tests automatizados');
console.log('   - forzarConfiguracionCompleta() - Reconfigurar sistema');
console.log('');
console.log('üéì Desarrollado con est√°ndares senior por GitHub Copilot');
